<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Diario de Oraci√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Mali:wght@400;600&family=Special+Elite&family=La+Belle+Aurore&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #eef2f5;
            --main-font: 'Comfortaa', cursive;
            --hand-font: 'Mali', cursive;
            --script-font: 'La Belle Aurore', cursive;
            --stamp-font: 'Special Elite', cursive;
            
            --notebook-bg: #fdfbf7;
            --notebook-margin: #e57373;
            
            /* Colores de Tinta */
            --ink-rosario: #d32f2f;
            --ink-coronilla: #303f9f;
        }

        body {
            font-family: var(--main-font);
            margin: 0;
            background-color: var(--bg-color);
            color: #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 60px;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .header-section { width: 100%; max-width: 1000px; display: flex; flex-direction: column; align-items: center; }
        .top-bar {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            padding: 15px 25px; box-sizing: border-box; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .user-greeting { font-weight: 700; cursor: pointer; color: #555; padding: 5px 10px; border-radius: 10px; transition: 0.2s; }
        .user-greeting:hover { background-color: #e0e0e0; }
        .streak-badge { display: flex; align-items: center; gap: 5px; background: #fff3e0; color: #e65100; border: 1px solid #ffb74d; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .tools { display: flex; gap: 10px; }
        .tool-btn { background: white; border: 1px solid #ccc; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-family: var(--main-font); transition: 0.2s; }
        .tool-btn:hover { background: #f5f5f5; }
        .banner-container { width: 100%; height: 160px; background-color: #ddd; border-radius: 0 0 20px 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .banner-img { width: 100%; height: 100%; object-fit: cover; }

        /* --- TABS --- */
        .tabs-container { width: 100%; max-width: 900px; display: flex; justify-content: center; margin: 30px 0; gap: 15px; flex-wrap: wrap; }
        .tab { padding: 12px 25px; cursor: pointer; border-radius: 30px; font-weight: 700; font-size: 0.9rem; background: #e0e0e0; color: #999; border: none; transition: all 0.3s; }
        .tab.active { background: white; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: #444; }
        .tab-rosario.active { color: var(--ink-rosario); }
        .tab-coronilla.active { color: var(--ink-coronilla); }
        .tab-devocional.active { color: #795548; }
        .tab-libros.active { color: #577590; }

        /* --- CONTENIDO --- */
        .main-content { width: 100%; max-width: 1000px; display: none; padding: 10px; box-sizing: border-box;}
        .main-content.active-view { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GRIDS (Rosario/Coronilla) --- */
        .grid-container { display: grid; grid-template-columns: 40px repeat(31, 1fr); gap: 4px; overflow-x: auto; padding: 25px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .month-label { font-size: 0.7rem; font-weight: bold; color: #bbb; text-transform: uppercase; align-self: center; }
        .grid-header { font-size: 0.7rem; text-align: center; color: #ccc; margin-bottom: 5px; font-weight: bold;}
        .day-cell { aspect-ratio: 1; background: #fafafa; border-radius: 4px; border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .day-cell:hover { border-color: #bbb; transform: scale(1.15); z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .day-cell.prayed-rosario { background-color: #ffcdd2 !important; border-color: #e57373; }
        .day-cell.prayed-coronilla { background-color: #e1bee7 !important; border-color: #ba68c8; }
        .help-section { display: flex; justify-content: center; width: 100%; margin-top: 10px; }
        .help-btn { text-decoration: none; background-color: #fbfbfb; color: #666; padding: 8px 18px; border: 1px dashed #aaa; border-radius: 2px; font-family: var(--hand-font); font-size: 0.85rem; display: flex; align-items: center; gap: 8px; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); transform: rotate(-1deg); transition: 0.2s; }
        .help-btn:hover { transform: rotate(0deg) scale(1.05); background-color: #fff; color: #333; }

        /* --- LAYOUT CUADERNO (Wrapper horizontal) --- */
        .notebook-layout {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 25px;
            width: 100%;
        }

        .notebook-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; perspective: 2000px; max-width: 750px; }
        .notebook-page {
            width: 100%; min-height: 800px;
            background-color: var(--notebook-bg);
            background-image: radial-gradient(#ccc 1.5px, transparent 1.5px);
            background-size: 25px 25px;
            border-radius: 4px 16px 16px 4px;
            box-shadow: 10px 10px 25px rgba(0,0,0,0.15), inset 30px 0 50px rgba(0,0,0,0.08);
            position: relative; padding: 40px 40px 50px 80px; box-sizing: border-box;
            transform-origin: left center; transform-style: preserve-3d;
        }
        .notebook-page::after { content: ''; position: absolute; top: 0; bottom: 0; left: 60px; width: 2px; background: var(--notebook-margin); opacity: 0.6; }
        .holes { position: absolute; left: 20px; top: 0; bottom: 0; display: flex; flex-direction: column; justify-content: space-evenly; height: 95%; margin: auto 0; }
        .hole { width: 16px; height: 16px; background: var(--bg-color); border-radius: 50%; box-shadow: inset 2px 2px 4px rgba(0,0,0,0.2); }

        .notebook-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; z-index: 2; position: relative;}
        .btn-vatican { text-decoration: none; background: #6d4c41; color: white; padding: 8px 16px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; letter-spacing: 0.5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-back-shelf { background: #577590; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; }
        
        .notebook-date { font-family: var(--hand-font); font-size: 1.3rem; color: #555; font-weight: bold; border-bottom: 2px solid #ddd; padding-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .notebook-date:hover { color: #d32f2f; border-bottom-color: #d32f2f; }
        
        .notebook-last-edit { font-family: var(--hand-font); font-size: 0.8rem; color: #999; font-style: italic; text-align: right; }

        .stamps-area { height: 90px; display: flex; justify-content: flex-end; align-items: flex-start; gap: 15px; margin-bottom: 5px; padding-right: 10px; position: relative; z-index: 1; }
        .stamp { position: relative; opacity: 0.85; mix-blend-mode: multiply; font-family: var(--stamp-font); text-transform: uppercase; animation: stampSmash 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .stamp-rosario { width: 80px; height: 80px; border: 3px solid var(--ink-rosario); border-radius: 50%; color: var(--ink-rosario); display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.6rem; text-align: center; line-height: 1.2; transform: rotate(-12deg); background: radial-gradient(circle, transparent 90%, var(--ink-rosario) 150%); }
        .stamp-rosario::before { content: ''; position: absolute; width: 120%; height: 40px; top: 20px; left: -10%; background: repeating-linear-gradient(45deg, transparent, transparent 3px, var(--ink-rosario) 3px, var(--ink-rosario) 4px); z-index: -1; opacity: 0.5; }
        .stamp-coronilla { width: 100px; height: 45px; border: 4px double var(--ink-coronilla); border-radius: 4px; color: var(--ink-coronilla); display: flex; justify-content: center; align-items: center; font-size: 1rem; font-weight: bold; letter-spacing: 1px; transform: rotate(5deg); }
        .stamp-coronilla span { border-bottom: 1px solid var(--ink-coronilla); padding-bottom: 2px; }
        @keyframes stampSmash { from { transform: scale(1.5) rotate(0deg); opacity: 0; } }

        /* --- BARRA DE HERRAMIENTAS VERTICAL --- */
        .editor-toolbar-vertical {
            display: flex;
            flex-direction: column; /* Vertical */
            gap: 15px;
            padding: 20px 10px;
            background-color: #fdfbf7;
            /* Textura de papel */
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmRmYmY3Ii8+CjxwYXRoIGQ9Ik0xIDNoMnYxSDF6IiBmaWxsPSIjZjBmMGZjIiBmaWxsLW9wYWNpdHk9IjAuMiIvPgo8L3N2Zz4=');
            border-radius: 4px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
            position: sticky; /* Se queda quieta al hacer scroll si el padre lo permite, o relative */
            top: 20px;
            border: 1px solid #ddd;
            z-index: 10;
        }

        /* Washi Tape "pegando" la barra vertical */
        .editor-toolbar-vertical::before {
            content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%) rotate(0deg); 
            width: 30px; height: 50px;
            background: rgba(230, 200, 180, 0.6);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            border-top: 1px dashed rgba(255,255,255,0.4); border-bottom: 1px dashed rgba(255,255,255,0.4);
            pointer-events: none;
        }

        .tool-separator-h { height: 1px; background: #ddd; width: 100%; margin: 5px 0; }

        .style-btn {
            width: 36px; height: 36px; border: none; background: #f4e1d2;
            color: #5d4037; font-family: var(--stamp-font); font-weight: bold; font-size: 1.1rem;
            cursor: pointer; border-radius: 4px; box-shadow: 1px 1px 3px rgba(0,0,0,0.15);
            transition: 0.2s; display: flex; justify-content: center; align-items: center;
        }
        .style-btn:hover { transform: scale(1.1) rotate(2deg); background: #fff; }

        .hl-btn {
            width: 28px; height: 28px; 
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            cursor: pointer; transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.4), 1px 1px 2px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center; align-self: center;
        }
        .hl-btn:hover { transform: scale(1.2) rotate(15deg); }
        .hl-btn.no-color { background: #fff; border: 1px dashed #aaa; border-radius: 50%; width: 26px; height: 26px; }
        .hl-btn.no-color span { font-size: 0.7rem; color: #888; }
        
        .clear-btn { background: transparent; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.6; transition: 0.2s; }
        .clear-btn:hover { opacity: 1; transform: rotate(90deg); color: #d32f2f; }

        /* DIV EDITABLE */
        .notebook-body { min-height: 550px; position: relative; margin-top: 10px; }
        .notebook-editable {
            width: 100%; min-height: 550px; height: 100%;
            background: transparent; border: none; outline: none;
            font-family: var(--hand-font); font-size: 1.35rem; line-height: 32px; color: #202020;
            white-space: pre-wrap; overflow-y: auto;
        }
        
        .page-info { position: absolute; bottom: 20px; right: 30px; font-size: 0.9rem; color: #999; font-style: italic; }
        .notebook-controls { display: flex; align-items: center; gap: 20px; margin-top: 30px; }
        .page-btn { background: white; border: none; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; font-size: 1.4rem; color: #666; transition: 0.2s; display: flex; justify-content: center; align-items: center; }
        .add-page-btn { background: #6d4c41; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
        .turning-page { animation: pageTurnEffect 0.8s ease-in-out forwards; }
        @keyframes pageTurnEffect { 0% { transform: rotateY(0deg); filter: brightness(1); } 40% { filter: brightness(0.9); } 50% { transform: rotateY(-90deg); filter: brightness(0.7); } 100% { transform: rotateY(0deg); filter: brightness(1); } }

        /* --- BIBLIOTECA PASTEL --- */
        .bookshelf-container { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; padding: 20px; }
        .book-item {
            width: 140px; height: 190px; background: #eee; border-radius: 5px 12px 12px 5px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2), inset 10px 0 20px rgba(0,0,0,0.1);
            cursor: pointer; position: relative; transition: transform 0.2s; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 10px; box-sizing: border-box;
        }
        .book-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: 8px 15px 25px rgba(0,0,0,0.25); }
        .book-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 12px; background: rgba(0,0,0,0.15); border-radius: 5px 0 0 5px; z-index: 1; }
        .book-add-new { border: 3px dashed #ccc; background: rgba(255,255,255,0.5); color: #aaa; }
        .book-add-new span { font-size: 3rem; font-weight: bold; }
        .book-title-cover { font-family: var(--stamp-font); color: rgba(255,255,255,0.9); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; z-index: 2; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); pointer-events: none; word-break: break-word; }
        
        /* --- MODALES --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; }
        .paper-note { width: 320px; background-color: #fdfbf7; padding: 35px 25px 25px 25px; box-shadow: 5px 15px 30px rgba(0,0,0,0.4); transform: rotate(-1deg); position: relative; border: 1px solid #ddd; }
        .paper-note::before { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 100px; height: 25px; background-color: rgba(220, 200, 180, 0.8); box-shadow: 0 1px 3px rgba(0,0,0,0.2); border-left: 2px dashed rgba(255,255,255,0.3); border-right: 2px dashed rgba(255,255,255,0.3); }
        .note-title { text-align: center; margin-top: 0; color: #333; font-family: var(--stamp-font); font-size: 1.2rem; border-bottom: 2px double #ccc; padding-bottom: 8px; margin-bottom: 15px; }
        .modal-label { display: block; font-family: var(--hand-font); font-size: 0.8rem; color: #888; margin-top: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;}
        .modal-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #aaa; padding: 6px 0; font-family: var(--script-font); font-size: 1.4rem; color: #222; outline: none; transition: 0.3s; }
        .modal-input:focus { border-bottom-color: #555; }
        select.modal-input { font-family: var(--hand-font); font-size: 1rem; }
        .modal-btn-group { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 15px; border-top: 1px dotted #ccc; }
        .btn-journal { background: transparent; border: 2px solid #555; padding: 6px 16px; font-family: var(--hand-font); font-weight: bold; font-size: 0.9rem; color: #555; cursor: pointer; border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; transition: 0.2s; }
        .btn-journal:hover { background: #555; color: #fff; transform: scale(1.05); }
        .btn-delete-icon { background: none; border: none; color: #d32f2f; font-size: 1.2rem; cursor: pointer; padding: 5px; opacity: 0.7; transition: 0.2s; }
        .btn-delete-icon:hover { opacity: 1; transform: scale(1.2); }
        
        .color-options { display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
        .color-swatch { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.2s; }
        .color-swatch:hover { transform: scale(1.2); }
        .color-swatch.selected { border-color: #555; transform: scale(1.1); }

        /* GRID VIEW MODAL */
        .grid-view-container { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; 
            max-height: 400px; overflow-y: auto; padding: 10px; width: 100%;
        }
        .grid-page-thumb {
            background: #fff; border: 1px solid #ccc; padding: 10px; height: 100px; 
            display: flex; flex-direction: column; justify-content: space-between; 
            cursor: pointer; border-radius: 5px; transition: 0.2s; position: relative;
        }
        .grid-page-thumb:hover { transform: scale(1.05); border-color: #888; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .thumb-preview { font-size: 0.5rem; color: #aaa; overflow: hidden; height: 60px; pointer-events: none; }
        .thumb-info { font-size: 0.7rem; font-weight: bold; color: #555; text-align: center; border-top: 1px dashed #eee; padding-top: 4px; }

        @media (max-width: 850px) {
            .notebook-layout { flex-direction: column; align-items: center; }
            .editor-toolbar-vertical { flex-direction: row; width: auto; position: static; margin-bottom: 10px; }
            .editor-toolbar-vertical::before { display: none; }
            .tool-separator-h { width: 1px; height: 20px; }
            .notebook-page { padding-left: 55px; padding-right: 20px; min-height: 600px; }
        }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="top-bar">
            <div class="user-info">
                <div id="greeting" class="user-greeting" onclick="openUserModal()">Hola, Peregrino</div>
                <div class="streak-badge">üî• <span id="streak-count">0</span></div>
            </div>
            <div class="tools">
                <button class="tool-btn" onclick="exportData()">üíæ Guardar</button>
                <button class="tool-btn" onclick="document.getElementById('file-input').click()">üìÇ Cargar</button>
                <input type="file" id="file-input" style="display:none" onchange="importData(this)">
            </div>
        </div>
        <div class="banner-container">
            <img src="banner.png" alt="Banner" class="banner-img" onerror="this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)'">
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab tab-rosario active" onclick="switchTab('rosario')">Rosario</button>
        <button class="tab tab-coronilla" onclick="switchTab('coronilla')">Coronilla</button>
        <button class="tab tab-devocional" onclick="switchTab('devocional')">Devocional</button>
        <button class="tab tab-libros" onclick="switchTab('libros')">Libros</button>
    </div>

    <div id="view-rosario" class="main-content active-view">
        <div id="grid-rosario" class="grid-container"></div>
        <div class="help-section">
            <a href="https://www.vatican.va/special/rosary/documents/misteri_sp.html" target="_blank" class="help-btn">‚ùì Ayuda con los Misterios</a>
        </div>
    </div>

    <div id="view-coronilla" class="main-content">
        <div id="grid-coronilla" class="grid-container"></div>
        <div class="help-section">
            <a href="https://www.vaticannews.va/es/oraciones/coronilla-de-la-divina-misericordia.html" target="_blank" class="help-btn">‚úùÔ∏è C√≥mo rezar la Coronilla</a>
        </div>
    </div>

    <div id="view-devocional" class="main-content">
        <div class="notebook-layout">
            <div class="notebook-wrapper">
                <div id="notebook-page-el" class="notebook-page">
                    <div class="holes"><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div></div>
                    <div class="notebook-header">
                        <a href="https://www.vaticannews.va/es/evangelio-de-hoy.html" target="_blank" class="btn-vatican">Lecturas</a>
                        <div id="notebook-date-display" class="notebook-date" title="Click para cambiar fecha" onclick="openDatePicker()"></div>
                        <input type="date" id="date-picker-input" style="display:none;" onchange="jumpToDate(this.value)">
                    </div>
                    <div id="stamps-area" class="stamps-area"></div>
                    
                    <div class="notebook-body">
                        <div id="notebook-editable" class="notebook-editable" contenteditable="true" oninput="autoSaveNote()"></div>
                    </div>
                    <div id="page-indicator" class="page-info">P√°g 1</div>
                    
                    <button id="btn-delete-dev-page" class="btn-delete-icon" style="position:absolute; bottom:20px; left:60px; display:none;" onclick="deleteCurrentDevotionalPage()" title="Eliminar esta hoja">üóëÔ∏è</button>
                </div>
                <div class="notebook-controls">
                    <button class="page-btn" onclick="prevPage()">‚ùÆ</button>
                    <button class="page-btn" onclick="toggleGridView('devocional')" title="Ver todas las entradas" style="font-size:1rem;">‚ò∑</button>
                    <button class="add-page-btn" onclick="addNewPage()">+ Hoja Nueva</button>
                    <button class="page-btn" onclick="nextPage()">‚ùØ</button>
                </div>
            </div>

            <div class="editor-toolbar-vertical">
                <button class="style-btn" onmousedown="event.preventDefault();" onclick="formatDoc('bold')" title="Negrita">N</button>
                <button class="style-btn" onmousedown="event.preventDefault();" onclick="formatDoc('underline')" title="Subrayado" style="text-decoration:underline;">S</button>
                <div class="tool-separator-h"></div>
                <div class="hl-btn" style="background:#fff59d;" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', '#fff59d')" title="Amarillo Luz"></div>
                <div class="hl-btn" style="background:#ffcdd2;" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', '#ffcdd2')" title="Rosa Pastel"></div>
                <div class="hl-btn" style="background:#c8e6c9;" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', '#c8e6c9')" title="Verde Hoja"></div>
                <div class="hl-btn" style="background:#b3e5fc;" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', '#b3e5fc')" title="Azul Cielo"></div>
                <div class="hl-btn no-color" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', 'transparent')" title="Sin Color"><span>üö´</span></div>
                <div class="tool-separator-h"></div>
                <button class="clear-btn" onmousedown="event.preventDefault();" onclick="formatDoc('removeFormat')" title="Borrar formato">‚úñ</button>
            </div>
        </div>
    </div>

    <div id="view-libros" class="main-content">
        <div id="bookshelf" class="bookshelf-container">
            <div class="book-item book-add-new" onclick="openNewBookModal()"><span>+</span></div>
        </div>

        <div id="book-reader" class="notebook-layout" style="display:none;">
            <div class="notebook-wrapper">
                <div id="book-page-el" class="notebook-page" style="background-color: #fffef0;">
                    <div class="holes"><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div></div>
                    
                    <div class="notebook-header">
                        <button class="btn-back-shelf" onclick="closeBook()">‚ùÆ Estanter√≠a</button>
                        <div style="display:flex; flex-direction:column; align-items:flex-end;">
                            <div id="book-title-display" class="notebook-date" style="border:none;">T√≠tulo</div>
                            <span id="book-last-edit" class="notebook-last-edit"></span>
                        </div>
                    </div>

                    <div class="notebook-body">
                        <div id="book-editable" class="notebook-editable" contenteditable="true" oninput="autoSaveBookPage()"></div>
                    </div>
                    
                    <div id="book-page-info" class="page-info">P√°g 1</div>
                    <button class="btn-delete-icon" style="position:absolute; bottom:20px; left:60px;" onclick="deleteCurrentBook()" title="Eliminar este cuaderno">üóëÔ∏è</button>
                </div>

                <div class="notebook-controls">
                    <button class="page-btn" onclick="prevBookPage()">‚ùÆ</button>
                    <button class="page-btn" onclick="toggleGridView('libro')" title="Ver todas las p√°ginas" style="font-size:1rem;">‚ò∑</button>
                    <button class="add-page-btn" onclick="addBookPage()">+ P√°g. Sig</button>
                    <button class="page-btn" onclick="nextBookPage()">‚ùØ</button>
                </div>
            </div>

            <div class="editor-toolbar-vertical">
                <button class="style-btn" onmousedown="event.preventDefault();" onclick="formatDoc('bold')" title="Negrita">N</button>
                <button class="style-btn" onmousedown="event.preventDefault();" onclick="formatDoc('underline')" title="Subrayado" style="text-decoration:underline;">S</button>
                <div class="tool-separator-h"></div>
                <div class="hl-btn" style="background:#fff59d;" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', '#fff59d')"></div>
                <div class="hl-btn" style="background:#ffcdd2;" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', '#ffcdd2')"></div>
                <div class="hl-btn" style="background:#c8e6c9;" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', '#c8e6c9')"></div>
                <div class="hl-btn" style="background:#b3e5fc;" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', '#b3e5fc')"></div>
                <div class="hl-btn no-color" onmousedown="event.preventDefault();" onclick="formatDoc('hiliteColor', 'transparent')" title="Sin Color"><span>üö´</span></div>
                <div class="tool-separator-h"></div>
                <button class="clear-btn" onmousedown="event.preventDefault();" onclick="formatDoc('removeFormat')" title="Limpiar formato">‚úñ</button>
            </div>
        </div>
    </div>

    <div id="grid-modal" class="modal">
        <div class="paper-note" style="width: 80%; max-width: 600px;">
            <h3 class="note-title">√çndice de P√°ginas</h3>
            <div id="grid-content" class="grid-view-container"></div>
            <div class="modal-btn-group" style="justify-content:center;">
                <button class="btn-journal" onclick="closeModal('grid-modal')">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="journal-modal" class="modal">
        <div class="paper-note">
            <h3 id="journal-date" class="note-title">Fecha</h3>
            <div id="rosario-options">
                <span class="modal-label">Misterios</span>
                <select id="f-mystery" class="modal-input" style="border-bottom:1px solid #888;">
                    <option value="Gozosos">Gozosos</option>
                    <option value="Luminosos">Luminosos</option>
                    <option value="Dolorosos">Dolorosos</option>
                    <option value="Gloriosos">Gloriosos</option>
                </select>
            </div>
            <span class="modal-label">Intenciones</span>
            <input type="text" id="f-intenciones" class="modal-input" placeholder="Escribe aqu√≠...">
            <span class="modal-label">Sentimientos</span>
            <input type="text" id="f-sentimientos" class="modal-input" placeholder="¬øC√≥mo te sientes?">
            <div class="modal-btn-group">
                <button class="btn-journal" onclick="closeModal('journal-modal')">Salir</button>
                <button id="btn-del" class="btn-delete-icon" onclick="deleteEntry()" title="Eliminar registro">üóëÔ∏è</button>
                <button class="btn-journal" style="background:#333; color:#fff;" onclick="saveEntry()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal">
        <div class="paper-note" style="text-align:center;">
            <h3 class="note-title">Pasaporte</h3>
            <span class="modal-label">Nombre del Peregrino</span>
            <input type="text" id="username-input" class="modal-input" placeholder="..." style="text-align:center;">
            <div class="modal-btn-group" style="justify-content:center;">
                <button class="btn-journal" onclick="saveUsername()">Comenzar</button>
            </div>
        </div>
    </div>

    <div id="new-book-modal" class="modal">
        <div class="paper-note">
            <h3 class="note-title">Nuevo Cuaderno</h3>
            <span class="modal-label">T√≠tulo del Libro</span>
            <input type="text" id="new-book-title" class="modal-input" placeholder="Ej: Confesiones..." maxlength="25">
            <span class="modal-label">Color de Portada</span>
            <div class="color-options">
                <div class="color-swatch" style="background:#a3b18a" onclick="selectColor(this, '#a3b18a')" title="Salvia"></div>
                <div class="color-swatch" style="background:#e5989b" onclick="selectColor(this, '#e5989b')" title="Rosa Polvo"></div>
                <div class="color-swatch" style="background:#bde0fe" onclick="selectColor(this, '#bde0fe')" title="Azul Empolvado"></div>
                <div class="color-swatch" style="background:#cdb4db" onclick="selectColor(this, '#cdb4db')" title="Lavanda"></div>
                <div class="color-swatch" style="background:#d6ccc2" onclick="selectColor(this, '#d6ccc2')" title="Arena"></div>
                <div class="color-swatch" style="background:#ffb5a7" onclick="selectColor(this, '#ffb5a7')" title="Melocot√≥n"></div>
            </div>
            <div class="modal-btn-group" style="justify-content:center;">
                <button class="btn-journal" onclick="createBook()">Crear</button>
            </div>
        </div>
    </div>

    <script>
        const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        let prayerData = JSON.parse(localStorage.getItem('prayerDataV9')) || { 
            rosario: {}, coronilla: {}, devocional: {}, library: [] 
        };
        if(!prayerData.library) prayerData.library = [];

        let userName = localStorage.getItem('prayerUserName');
        let viewDate = new Date();
        let currentPageIndex = 0;
        let selectedGridKey = null;
        let currentModalType = '';
        let selectedBookColor = '#a3b18a';
        let currentBookId = null;
        let currentBookPageIndex = 0;

        function init() {
            if (!userName) document.getElementById('user-modal').style.display = 'flex';
            else document.getElementById('greeting').innerText = `Hola, ${userName}`;
            renderGrid('rosario'); renderGrid('coronilla');
            updateNotebook(false); updateStreak(); renderBookshelf();
        }

        function formatDoc(cmd, value = null) {
            document.execCommand(cmd, false, value);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.main-content').forEach(c => c.classList.remove('active-view'));
            document.querySelector(`.tab-${tab}`).classList.add('active');
            document.getElementById(`view-${tab}`).classList.add('active-view');
            
            if(tab === 'devocional') updateNotebook(false);
            if(tab === 'libros') {
                document.getElementById('bookshelf').style.display = 'flex';
                document.getElementById('book-reader').style.display = 'none'; 
                renderBookshelf();
            }
        }

        // --- DEVOCIONAL ---
        function getKey(date) { return `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`; }
        
        function updateNotebook(animate = true) {
            const pageEl = document.getElementById('notebook-page-el');
            const fillData = () => {
                const key = getKey(viewDate);
                if (!prayerData.devocional) prayerData.devocional = {};
                if (!prayerData.devocional[key]) prayerData.devocional[key] = [""]; 
                const pages = prayerData.devocional[key];
                if(currentPageIndex >= pages.length) currentPageIndex = pages.length - 1;
                if(currentPageIndex < 0) currentPageIndex = 0;
                
                document.getElementById('notebook-editable').innerHTML = pages[currentPageIndex];
                
                const options = { weekday: 'long', day: 'numeric', month: 'long' };
                document.getElementById('notebook-date-display').innerText = viewDate.toLocaleDateString('es-ES', options);
                document.getElementById('page-indicator').innerText = `P√°g. ${currentPageIndex + 1} de ${pages.length}`;
                
                // --- L√ìGICA PARA EL BOT√ìN ELIMINAR ---
                const delBtn = document.getElementById('btn-delete-dev-page');
                if (pages.length > 1) {
                    delBtn.style.display = 'block';
                } else {
                    delBtn.style.display = 'none';
                }
                
                const gridKey = `${viewDate.getMonth()}-${viewDate.getDate()}`;
                const stamps = document.getElementById('stamps-area');
                stamps.innerHTML = '';
                if (prayerData.rosario && prayerData.rosario[gridKey]) stamps.innerHTML += `<div class="stamp stamp-rosario"><span>ROSARIO<br>REZADO<br>‚úù</span></div>`;
                if (prayerData.coronilla && prayerData.coronilla[gridKey]) stamps.innerHTML += `<div class="stamp stamp-coronilla"><span>CORONILLA</span></div>`;
            };
            if (animate) {
                pageEl.classList.remove('turning-page'); void pageEl.offsetWidth; pageEl.classList.add('turning-page'); setTimeout(fillData, 400); 
            } else fillData();
        }

        // --- NUEVA FUNCI√ìN PARA ELIMINAR HOJA DEVOCIONAL ---
        function deleteCurrentDevotionalPage() {
            const key = getKey(viewDate);
            const pages = prayerData.devocional[key];
            
            if (pages.length <= 1) return; // Seguridad

            if(confirm("¬øEliminar esta hoja del diario?")) {
                pages.splice(currentPageIndex, 1);
                // Si borramos la √∫ltima, volvemos a la anterior
                if (currentPageIndex >= pages.length) {
                    currentPageIndex = pages.length - 1;
                }
                saveLocal();
                updateNotebook(true);
            }
        }

        function autoSaveNote() {
            const key = getKey(viewDate);
            prayerData.devocional[key][currentPageIndex] = document.getElementById('notebook-editable').innerHTML;
            saveLocal();
        }
        function addNewPage() {
            const key = getKey(viewDate);
            prayerData.devocional[key].push(""); currentPageIndex = prayerData.devocional[key].length - 1; updateNotebook(true);
        }
        function nextPage() {
            const key = getKey(viewDate);
            if (currentPageIndex < prayerData.devocional[key].length - 1) currentPageIndex++;
            else { viewDate.setDate(viewDate.getDate() + 1); currentPageIndex = 0; }
            updateNotebook(true);
        }
        function prevPage() {
            if (currentPageIndex > 0) currentPageIndex--;
            else { viewDate.setDate(viewDate.getDate() - 1); const key = getKey(viewDate); currentPageIndex = (prayerData.devocional[key]) ? prayerData.devocional[key].length - 1 : 0; }
            updateNotebook(true);
        }
        
        // --- FECHA PICKER ---
        function openDatePicker() {
            document.getElementById('date-picker-input').showPicker();
        }
        function jumpToDate(val) {
            if(!val) return;
            const parts = val.split('-');
            viewDate = new Date(parts[0], parts[1]-1, parts[2]);
            currentPageIndex = 0;
            updateNotebook(true);
        }

        // --- GRID VIEW LOGIC ---
        function toggleGridView(mode) {
            const container = document.getElementById('grid-content');
            container.innerHTML = '';
            
            if (mode === 'devocional') {
                const entries = Object.keys(prayerData.devocional || {}).sort((a,b) => {
                    const da = a.split('-').map(Number); const db = b.split('-').map(Number);
                    return new Date(da[0], da[1], da[2]) - new Date(db[0], db[1], db[2]);
                });

                if(entries.length === 0) container.innerHTML = '<p style="text-align:center; width:100%; color:#999;">A√∫n no has escrito nada.</p>';
                
                entries.forEach(key => {
                    const pages = prayerData.devocional[key];
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = pages[0];
                    const textPreview = tempDiv.textContent || tempDiv.innerText || "";
                    
                    const [y, m, d] = key.split('-');
                    const dateObj = new Date(y, m, d);
                    const niceDate = dateObj.toLocaleDateString('es-ES', {month:'short', day:'numeric'});

                    const card = document.createElement('div');
                    card.className = 'grid-page-thumb';
                    card.onclick = () => {
                        viewDate = dateObj;
                        currentPageIndex = 0;
                        updateNotebook(true);
                        closeModal('grid-modal');
                    };
                    card.innerHTML = `<div class="thumb-preview">${textPreview.substring(0,60)}...</div><div class="thumb-info">${niceDate}</div>`;
                    container.appendChild(card);
                });

            } else if (mode === 'libro') {
                const book = getBook();
                if(!book) return;
                
                book.pages.forEach((p, idx) => {
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = p.text;
                    const textPreview = tempDiv.textContent || tempDiv.innerText || "";

                    const card = document.createElement('div');
                    card.className = 'grid-page-thumb';
                    card.onclick = () => {
                        currentBookPageIndex = idx;
                        updateBookView(true);
                        closeModal('grid-modal');
                    };
                    card.innerHTML = `<div class="thumb-preview">${textPreview.substring(0,60)}...</div><div class="thumb-info">P√°g ${idx+1}</div>`;
                    container.appendChild(card);
                });
            }
            document.getElementById('grid-modal').style.display = 'flex';
        }

        // --- BIBLIOTECA ---
        function openNewBookModal() {
            document.getElementById('new-book-title').value = '';
            document.getElementById('new-book-modal').style.display = 'flex';
            const swatches = document.querySelectorAll('.color-swatch');
            swatches[0].classList.add('selected');
            selectedBookColor = '#a3b18a';
        }
        function selectColor(el, color) {
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected'); selectedBookColor = color;
        }
        function createBook() {
            const title = document.getElementById('new-book-title').value.trim() || "Sin T√≠tulo";
            const newBook = { id: Date.now().toString(), title: title, color: selectedBookColor, pages: [{ text: "", date: new Date().toLocaleDateString() }] };
            prayerData.library.push(newBook); saveLocal(); closeModal('new-book-modal'); renderBookshelf();
        }
        function renderBookshelf() {
            const shelf = document.getElementById('bookshelf');
            shelf.innerHTML = `<div class="book-item book-add-new" onclick="openNewBookModal()"><span>+</span></div>`;
            prayerData.library.forEach(book => {
                const bookDiv = document.createElement('div');
                bookDiv.className = 'book-item';
                bookDiv.style.background = `linear-gradient(135deg, ${book.color} 0%, #fff 250%)`;
                bookDiv.innerHTML = `<div class="book-title-cover">${book.title}</div>`;
                bookDiv.onclick = () => openBook(book.id);
                shelf.appendChild(bookDiv);
            });
        }
        function openBook(id) {
            currentBookId = id; currentBookPageIndex = 0;
            document.getElementById('bookshelf').style.display = 'none';
            document.getElementById('book-reader').style.display = 'flex'; 
            updateBookView(false);
        }
        function closeBook() { currentBookId = null; document.getElementById('book-reader').style.display = 'none'; document.getElementById('bookshelf').style.display = 'flex'; }
        function getBook() { return prayerData.library.find(b => b.id === currentBookId); }
        function updateBookView(animate = true) {
            const book = getBook(); if(!book) return;
            const pageEl = document.getElementById('book-page-el');
            const fillData = () => {
                document.getElementById('book-title-display').innerText = book.title;
                const pageData = book.pages[currentBookPageIndex];
                document.getElementById('book-editable').innerHTML = pageData.text; 
                document.getElementById('book-last-edit').innerText = pageData.date ? `Editado: ${pageData.date}` : '';
                document.getElementById('book-page-info').innerText = `P√°g. ${currentBookPageIndex + 1} de ${book.pages.length}`;
            };
            if (animate) {
                pageEl.classList.remove('turning-page'); void pageEl.offsetWidth; pageEl.classList.add('turning-page'); setTimeout(fillData, 400); 
            } else fillData();
        }
        function autoSaveBookPage() {
            const book = getBook();
            if(book) {
                book.pages[currentBookPageIndex].text = document.getElementById('book-editable').innerHTML;
                book.pages[currentBookPageIndex].date = new Date().toLocaleDateString();
                saveLocal();
            }
        }
        function addBookPage() {
            const book = getBook();
            if(book) { book.pages.push({ text: "", date: new Date().toLocaleDateString() }); currentBookPageIndex = book.pages.length - 1; updateBookView(true); saveLocal(); }
        }
        function nextBookPage() {
            const book = getBook();
            if(book && currentBookPageIndex < book.pages.length - 1) { currentBookPageIndex++; updateBookView(true); } else addBookPage();
        }
        function prevBookPage() { if(currentBookPageIndex > 0) { currentBookPageIndex--; updateBookView(true); } }
        function deleteCurrentBook() {
            if(confirm("¬øEliminar este cuaderno?")) { prayerData.library = prayerData.library.filter(b => b.id !== currentBookId); saveLocal(); closeBook(); renderBookshelf(); }
        }

        // --- CORE UTILS ---
        function checkPrayerDay(d) { const k = `${d.getMonth()}-${d.getDate()}`; return (prayerData.rosario && prayerData.rosario[k]?.prayed) || (prayerData.coronilla && prayerData.coronilla[k]?.prayed); }
        function updateStreak() {
            let s = 0, d = new Date();
            if (checkPrayerDay(d)) { s++; d.setDate(d.getDate() - 1); }
            else { let y = new Date(d); y.setDate(y.getDate() - 1); if (checkPrayerDay(y)) d.setDate(d.getDate() - 1); else { document.getElementById('streak-count').innerText = 0; return; } }
            while (true) { if (checkPrayerDay(d)) { s++; d.setDate(d.getDate() - 1); } else break; if (s > 3650) break; }
            document.getElementById('streak-count').innerText = s;
        }
        function renderGrid(type) {
            const grid = document.getElementById(`grid-${type}`);
            grid.innerHTML = ''; grid.appendChild(createDiv('')); 
            for (let i = 1; i <= 31; i++) grid.appendChild(createDiv(i, 'grid-header'));
            months.forEach((m, mIdx) => {
                grid.appendChild(createDiv(m, 'month-label'));
                for (let d = 1; d <= 31; d++) {
                    const cell = document.createElement('div'); cell.className = 'day-cell';
                    if (d > daysInMonth[mIdx]) cell.style.visibility = 'hidden';
                    else {
                        const k = `${mIdx}-${d}`;
                        if (prayerData[type] && prayerData[type][k]) cell.classList.add(`prayed-${type}`);
                        cell.onclick = () => openJournalModal(type, mIdx, d);
                    }
                    grid.appendChild(cell);
                }
            });
        }
        function createDiv(t, c) { const d = document.createElement('div'); if(c) d.className=c; d.innerText=t; return d; }
        function openJournalModal(type, m, d) {
            currentModalType = type; selectedGridKey = `${m}-${d}`;
            const entry = (prayerData[type] && prayerData[type][selectedGridKey]) || {};
            document.getElementById('journal-date').innerText = `D√≠a ${d} de ${months[m]}`;
            document.getElementById('f-intenciones').value = entry.intenciones || '';
            document.getElementById('f-sentimientos').value = entry.sentimientos || '';
            document.getElementById('rosario-options').style.display = (type === 'rosario') ? 'block' : 'none';
            if(type === 'rosario') document.getElementById('f-mystery').value = entry.mystery || 'Gozosos';
            const btnDel = document.getElementById('btn-del');
            if (entry.prayed) btnDel.style.visibility = 'visible'; else btnDel.style.visibility = 'hidden';
            document.getElementById('journal-modal').style.display = 'flex';
        }
        function saveEntry() {
            if(!prayerData[currentModalType]) prayerData[currentModalType] = {};
            prayerData[currentModalType][selectedGridKey] = { prayed: true, mystery: document.getElementById('f-mystery').value, intenciones: document.getElementById('f-intenciones').value, sentimientos: document.getElementById('f-sentimientos').value };
            saveLocal(); updateStreak(); closeModal('journal-modal'); renderGrid(currentModalType);
        }
        function deleteEntry() {
            if(confirm('¬øBorrar registro?')) { delete prayerData[currentModalType][selectedGridKey]; saveLocal(); updateStreak(); closeModal('journal-modal'); renderGrid(currentModalType); }
        }
        function saveLocal() { localStorage.setItem('prayerDataV9', JSON.stringify(prayerData)); }
        function saveUsername() { const v = document.getElementById('username-input').value; if(v) { userName = v; localStorage.setItem('prayerUserName', userName); document.getElementById('greeting').innerText = `Hola, ${v}`; closeModal('user-modal'); } }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = e => { if(e.target.classList.contains('modal')) e.target.style.display = 'none'; }
        function openUserModal() { document.getElementById('username-input').value = userName || ''; document.getElementById('user-modal').style.display = 'flex'; }
        function exportData() { const b = new Blob([JSON.stringify({user: userName, data: prayerData})], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `diario_${userName}.json`; a.click(); }
        function importData(inp) { const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(d.data) { prayerData = d.data; if(d.user) localStorage.setItem('prayerUserName', d.user); saveLocal(); location.reload(); } } catch(x) {} }; if(inp.files[0]) r.readAsText(inp.files[0]); }
        init();
    </script>
</body>
</html>